<?php
/*
Plugin Name: Random Quotes
Description: Плагин для вывода случайных цитат и добавления их через админку.
Version: 1.0
Author: Maks Ilin
*/

if (!defined('ABSPATH')) exit; // Защита от прямого доступа

// Создание таблицы при активации
register_activation_hook(__FILE__, 'rq_create_table');
function rq_create_table() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'quotes';
    $charset_collate = $wpdb->get_charset_collate();
    
    $sql = "CREATE TABLE $table_name (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        text text NOT NULL,
        author varchar(255),
        PRIMARY KEY  (id)
    ) $charset_collate;";
    
    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

// Шорткод [random_quote]
add_shortcode('random_quote', 'rq_display_random_quote');
function rq_display_random_quote() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'quotes';
    
    $quote = $wpdb->get_row("SELECT * FROM $table_name ORDER BY RAND() LIMIT 1");
    
    if ($quote) {
        return '<blockquote>' . esc_html($quote->text) . '<br><small>' . esc_html($quote->author) . '</small></blockquote>';
    } else {
        return 'Нет цитат для отображения.';
    }
}

// Страница админки
add_action('admin_menu', 'rq_admin_menu');
function rq_admin_menu() {
    add_menu_page(
        'Random Quotes',
        'Random Quotes',
        'manage_options',
        'random-quotes',
        'rq_admin_page',
        'dashicons-format-quote',
        20
    );
}

// Форма добавления цитат в админке
function rq_admin_page() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'quotes';

    if (isset($_POST['rq_submit'])) {
        $text = sanitize_textarea_field($_POST['rq_text']);
        $author = sanitize_text_field($_POST['rq_author']);
        $wpdb->insert($table_name, ['text' => $text, 'author' => $author]);
        echo '<div class="updated"><p>Цитата добавлена!</p></div>';
    }

    ?>
    <div class="wrap">
        <h1>Добавить новую цитату</h1>
        <form method="post">
            <table class="form-table">
                <tr>
                    <th>Цитата</th>
                    <td><textarea name="rq_text" rows="5" cols="50" required></textarea></td>
                </tr>
                <tr>
                    <th>Автор</th>
                    <td><input type="text" name="rq_author" size="50"></td>
                </tr>
            </table>
            <p><input type="submit" name="rq_submit" class="button button-primary" value="Добавить цитату"></p>
        </form>
    </div>
    <?php
}
